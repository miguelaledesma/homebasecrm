// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  SALES_REP
  CONCIERGE
}

enum SourceType {
  CALL_IN
  WALK_IN
  REFERRAL
}

enum LeadType {
  FLOOR
  CARPET
  TILE_STONE
  MATERIALS
  KITCHEN
  BATH
  ADUS
  PAINTING
  ROOFING
  STUCCO
  CONCRETE
  TURF
  LANDSCAPING
  MONTHLY_YARD_MAINTENANCE
  LABOR
  OTHER
}

enum LeadStatus {
  NEW
  ASSIGNED
  APPOINTMENT_SET
  QUOTED
  WON
  LOST
}

enum JobStatus {
  SCHEDULED
  IN_PROGRESS
  DONE
}

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  DECLINED
  EXPIRED
}

enum HearAboutUs {
  YELP
  FACEBOOK
  DRIVING_BY
  RETURNING_CUSTOMER
  OTHER
}

enum NotificationType {
  LEAD_INACTIVITY
  ADMIN_COMMENT
  CONCIERGE_LEAD
  CALENDAR_TASK
}

enum TaskType {
  LEAD_INACTIVITY
}

enum TaskStatus {
  PENDING
  ACKNOWLEDGED
  RESOLVED
}

model User {
  id        String   @id @default(cuid())
  name      String?
  email     String   @unique
  password  String? // Hashed password (nullable for existing users, required for new invites)
  role      UserRole @default(SALES_REP)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  assignedLeads             Lead[]               @relation("AssignedSalesRep")
  createdLeads              Lead[]               @relation("LeadCreator")
  appointments              Appointment[]
  quotes                    Quote[]
  uploadedQuoteFiles        QuoteFile[]
  leadNotes                 LeadNote[]           @relation("LeadNoteCreator")
  notifications             Notification[]
  tasks                     Task[]
  passwordResetTokens       PasswordResetToken[]
  crewMemberships           CrewMember[]
  calendarReminders         CalendarReminder[]   @relation("CalendarReminderCreator")
  assignedCalendarReminders CalendarReminder[]   @relation("CalendarReminderAssignee")

  @@map("users")
}

model UserInvitation {
  id        String   @id @default(cuid())
  email     String
  role      UserRole
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  createdBy String? // ID of admin who created the invitation

  @@index([email])
  @@map("user_invitations")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  createdBy String? // ID of admin who created the reset token

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("password_reset_tokens")
}

model Customer {
  id           String     @id @default(cuid())
  firstName    String
  lastName     String
  phone        String?
  email        String?
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  zip          String?
  sourceType   SourceType
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Relations
  leads         Lead[] @relation("CustomerLeads")
  referredLeads Lead[] @relation("ReferrerCustomer")

  @@index([phone])
  @@index([email])
  @@map("customers")
}

model Lead {
  id                 String     @id @default(cuid())
  customerNumber     String?    @unique // Customer number starting with 105-
  customerId         String
  leadTypes          LeadType[]
  description        String?
  status             LeadStatus @default(NEW)
  closedDate         DateTime?
  jobStatus          JobStatus? // Only relevant when status is WON
  jobScheduledDate   DateTime? // Date when job is scheduled to start
  jobCompletedDate   DateTime? // Date when job status was set to DONE
  assignedSalesRepId String?
  createdBy          String? // ID of user who created the lead
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  // Referral tracking
  referrerFirstName  String?
  referrerLastName   String?
  referrerPhone      String?
  referrerEmail      String?
  referrerCustomerId String? // Link to existing customer if referrer is in system
  referrerIsCustomer Boolean @default(false)

  // Customer classification
  isMilitaryFirstResponder Boolean @default(false)
  isContractor             Boolean @default(false)
  contractorLicenseNumber  String?

  // Marketing attribution
  hearAboutUs      HearAboutUs?
  hearAboutUsOther String? // Free text when hearAboutUs is OTHER

  // Relations
  customer         Customer            @relation("CustomerLeads", fields: [customerId], references: [id], onDelete: Cascade)
  assignedSalesRep User?               @relation("AssignedSalesRep", fields: [assignedSalesRepId], references: [id])
  createdByUser    User?               @relation("LeadCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  referrerCustomer Customer?           @relation("ReferrerCustomer", fields: [referrerCustomerId], references: [id], onDelete: SetNull)
  appointments     Appointment[]
  quotes           Quote[]
  notes            LeadNote[]
  notifications    Notification[]
  tasks            Task[]
  crewAssignments  JobCrewAssignment[]

  @@index([status])
  @@index([assignedSalesRepId])
  @@index([createdAt(sort: Desc)])
  @@index([status, assignedSalesRepId])
  @@index([createdBy])
  @@index([customerNumber])
  @@map("leads")
}

model Appointment {
  id               String            @id @default(cuid())
  leadId           String
  salesRepId       String?
  scheduledFor     DateTime
  siteAddressLine1 String?
  siteAddressLine2 String?
  city             String?
  state            String?
  zip              String?
  status           AppointmentStatus @default(SCHEDULED)
  notes            String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  // Relations
  lead     Lead    @relation(fields: [leadId], references: [id], onDelete: Cascade)
  salesRep User?   @relation(fields: [salesRepId], references: [id], onDelete: SetNull)
  quotes   Quote[]

  @@index([salesRepId])
  @@index([status])
  @@index([scheduledFor])
  @@index([leadId])
  @@index([salesRepId, status, scheduledFor])
  @@map("appointments")
}

model Quote {
  id            String      @id @default(cuid())
  quoteNumber   String?     @unique
  leadId        String
  appointmentId String?
  salesRepId    String?
  amount        Float
  currency      String      @default("USD")
  sentAt        DateTime?
  expiresAt     DateTime?
  status        QuoteStatus @default(DRAFT)
  expenses      Json? // Flexible JSON object for expense tracking: { "category": amount }
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  lead        Lead         @relation(fields: [leadId], references: [id], onDelete: Cascade)
  appointment Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  salesRep    User?        @relation(fields: [salesRepId], references: [id], onDelete: SetNull)
  files       QuoteFile[]

  @@index([salesRepId])
  @@index([status])
  @@index([leadId])
  @@index([quoteNumber])
  @@map("quotes")
}

model QuoteFile {
  id               String   @id @default(cuid())
  quoteId          String
  fileUrl          String
  fileType         String?
  isProfitLoss     Boolean  @default(false) // True if this is a profit & loss file for financials
  uploadedByUserId String?
  uploadedAt       DateTime @default(now())

  // Relations
  quote      Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  uploadedBy User? @relation(fields: [uploadedByUserId], references: [id], onDelete: SetNull)

  @@map("quote_files")
}

model LeadNote {
  id        String   @id @default(cuid())
  leadId    String
  content   String
  createdBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  lead          Lead           @relation(fields: [leadId], references: [id], onDelete: Cascade)
  createdByUser User?          @relation("LeadNoteCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  notifications Notification[]

  @@index([leadId])
  @@index([createdAt(sort: Desc)])
  @@map("lead_notes")
}

model Notification {
  id             String           @id @default(cuid())
  userId         String // User who receives the notification
  type           NotificationType
  read           Boolean          @default(false)
  readAt         DateTime?
  acknowledged   Boolean          @default(false) // Explicit acknowledgment flag
  acknowledgedAt DateTime?
  createdAt      DateTime         @default(now())

  // Context data
  leadId             String? // Lead this notification is about
  noteId             String? // Note that triggered admin comment notification
  taskId             String? @unique // Link to related task
  calendarReminderId String? @unique // Link to calendar reminder/task

  // Relations
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  lead             Lead?             @relation(fields: [leadId], references: [id], onDelete: Cascade)
  note             LeadNote?         @relation(fields: [noteId], references: [id], onDelete: SetNull)
  task             Task?             @relation(fields: [taskId], references: [id], onDelete: SetNull)
  calendarReminder CalendarReminder? @relation(fields: [calendarReminderId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([userId, acknowledged])
  @@index([userId, createdAt(sort: Desc)])
  @@index([leadId])
  @@map("notifications")
}

model Task {
  id             String     @id @default(cuid())
  userId         String // User who needs to complete the task
  type           TaskType
  status         TaskStatus @default(PENDING)
  leadId         String // Lead this task is about
  createdAt      DateTime   @default(now())
  acknowledgedAt DateTime?
  resolvedAt     DateTime?

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  lead         Lead          @relation(fields: [leadId], references: [id], onDelete: Cascade)
  notification Notification? // Link to related notification

  @@unique([leadId, type]) // One task per lead per type
  @@index([userId, status])
  @@index([leadId])
  @@map("tasks")
}

model Crew {
  id          String   @id @default(cuid())
  name        String
  description String?
  memberNames Json? // Array of external member names: ["John Doe", "Jane Smith"]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  members        CrewMember[]
  jobAssignments JobCrewAssignment[]

  @@map("crews")
}

model CrewMember {
  crewId String
  userId String

  // Relations
  crew Crew @relation(fields: [crewId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([crewId, userId])
  @@index([crewId])
  @@index([userId])
  @@map("crew_members")
}

model JobCrewAssignment {
  id         String   @id @default(cuid())
  leadId     String // References Lead (job)
  crewId     String
  assignedAt DateTime @default(now())
  assignedBy String? // User ID who made the assignment

  // Relations
  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  crew Crew @relation(fields: [crewId], references: [id], onDelete: Cascade)

  @@unique([leadId, crewId]) // Prevent duplicate assignments
  @@index([leadId])
  @@index([crewId])
  @@map("job_crew_assignments")
}

model CalendarReminder {
  id             String   @id @default(cuid())
  title          String
  description    String?
  scheduledFor   DateTime
  userId         String // Creator of the reminder
  assignedUserId String? // User assigned to complete the task (optional)
  color          String? // Hex color code for calendar display (e.g., "#3b82f6")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  user          User           @relation("CalendarReminderCreator", fields: [userId], references: [id], onDelete: Cascade)
  assignedUser  User?          @relation("CalendarReminderAssignee", fields: [assignedUserId], references: [id], onDelete: SetNull)
  notifications Notification[]

  @@index([userId])
  @@index([assignedUserId])
  @@index([scheduledFor])
  @@map("calendar_reminders")
}
