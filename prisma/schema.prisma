// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  SALES_REP
}

enum SourceType {
  CALL_IN
  WALK_IN
  REFERRAL
}

enum LeadType {
  FLOOR
  CARPET
  TILE_STONE
  MATERIALS
  KITCHEN
  BATH
  ADUS
  PAINTING
  ROOFING
  STUCCO
  CONCRETE
  TURF
  LANDSCAPING
  MONTHLY_YARD_MAINTENANCE
  OTHER
}

enum LeadStatus {
  NEW
  ASSIGNED
  APPOINTMENT_SET
  QUOTED
  WON
  LOST
}

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  DECLINED
  EXPIRED
}

enum HearAboutUs {
  YELP
  FACEBOOK
  DRIVING_BY
  OTHER
}

model User {
  id        String   @id @default(cuid())
  name      String?
  email     String   @unique
  password  String? // Hashed password (nullable for existing users, required for new invites)
  role      UserRole @default(SALES_REP)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  assignedLeads      Lead[]        @relation("AssignedSalesRep")
  createdLeads        Lead[]        @relation("LeadCreator")
  appointments       Appointment[]
  quotes             Quote[]
  uploadedQuoteFiles QuoteFile[]
  leadNotes          LeadNote[]    @relation("LeadNoteCreator")

  @@map("users")
}

model UserInvitation {
  id        String   @id @default(cuid())
  email     String
  role      UserRole
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  createdBy String? // ID of admin who created the invitation

  @@index([email])
  @@map("user_invitations")
}

model Customer {
  id           String     @id @default(cuid())
  firstName    String
  lastName     String
  phone        String?
  email        String?
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  zip          String?
  sourceType   SourceType
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Relations
  leads           Lead[] @relation("CustomerLeads")
  referredLeads  Lead[] @relation("ReferrerCustomer")

  @@index([phone])
  @@index([email])
  @@map("customers")
}

model Lead {
  id                 String     @id @default(cuid())
  customerId         String
  leadTypes          LeadType[]
  description        String?
  status             LeadStatus @default(NEW)
  assignedSalesRepId String?
  createdBy          String?    // ID of user who created the lead
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  // Referral tracking
  referrerFirstName   String?
  referrerLastName    String?
  referrerPhone       String?
  referrerEmail       String?
  referrerCustomerId  String?  // Link to existing customer if referrer is in system
  referrerIsCustomer  Boolean  @default(false)

  // Customer classification
  isMilitaryFirstResponder Boolean @default(false)
  isContractor             Boolean @default(false)
  contractorLicenseNumber   String?

  // Marketing attribution
  hearAboutUs              HearAboutUs?
  hearAboutUsOther         String?  // Free text when hearAboutUs is OTHER

  // Relations
  customer         Customer      @relation("CustomerLeads", fields: [customerId], references: [id], onDelete: Cascade)
  assignedSalesRep User?         @relation("AssignedSalesRep", fields: [assignedSalesRepId], references: [id])
  createdByUser    User?         @relation("LeadCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  referrerCustomer Customer?     @relation("ReferrerCustomer", fields: [referrerCustomerId], references: [id], onDelete: SetNull)
  appointments     Appointment[]
  quotes           Quote[]
  notes            LeadNote[]

  @@index([status])
  @@index([assignedSalesRepId])
  @@index([createdAt(sort: Desc)])
  @@index([status, assignedSalesRepId])
  @@index([createdBy])
  @@map("leads")
}

model Appointment {
  id               String            @id @default(cuid())
  leadId           String
  salesRepId       String
  scheduledFor     DateTime
  siteAddressLine1 String?
  siteAddressLine2 String?
  city             String?
  state            String?
  zip              String?
  status           AppointmentStatus @default(SCHEDULED)
  notes            String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  // Relations
  lead     Lead    @relation(fields: [leadId], references: [id], onDelete: Cascade)
  salesRep User    @relation(fields: [salesRepId], references: [id])
  quotes   Quote[]

  @@index([salesRepId])
  @@index([status])
  @@index([scheduledFor])
  @@index([leadId])
  @@index([salesRepId, status, scheduledFor])
  @@map("appointments")
}

model Quote {
  id            String      @id @default(cuid())
  leadId        String
  appointmentId String?
  salesRepId    String
  amount        Float
  currency      String      @default("USD")
  sentAt        DateTime?
  expiresAt     DateTime?
  status        QuoteStatus @default(DRAFT)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  lead        Lead         @relation(fields: [leadId], references: [id], onDelete: Cascade)
  appointment Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
  salesRep    User         @relation(fields: [salesRepId], references: [id])
  files       QuoteFile[]

  @@index([salesRepId])
  @@index([status])
  @@index([leadId])
  @@map("quotes")
}

model QuoteFile {
  id               String   @id @default(cuid())
  quoteId          String
  fileUrl          String
  fileType         String?
  uploadedByUserId String
  uploadedAt       DateTime @default(now())

  // Relations
  quote      Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  uploadedBy User  @relation(fields: [uploadedByUserId], references: [id])

  @@map("quote_files")
}

model LeadNote {
  id        String   @id @default(cuid())
  leadId    String
  content   String
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  lead      Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  createdByUser User @relation("LeadNoteCreator", fields: [createdBy], references: [id])

  @@index([leadId])
  @@index([createdAt(sort: Desc)])
  @@map("lead_notes")
}
